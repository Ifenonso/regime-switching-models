% Solving Coupled System of 
% Regime Switching American Option Pricing Model 
% with Dormand-Prince 5(4) RK-Embedded Pairs 
% and 4th-Order Compact Scheme

clc
clear all
close all

format long
%% first data with high volatility
r = [0.1 0.05];     % risk free interest for each regime
sigma = [0.8 0.3];  % volatility for each regime
K = 9;              % asset price at expiration time
T = 1;              % expiration time
Q = [-6 6;9 -9];    % regime generator matrix
% Q = [0 0;0 0];      % no tansistion

%% second data with low volatility
% r = [0.1 0.1];      % risk free interest for each regime
% sigma = [0.4 0.2];  % volatility for each regime
% K = 100;            % asset price at expiration time
% T = 1;              % expiration time
% Q = [-1.375968919 1.375968919;1.031976689 -1.031976689]; % Gen. matrix

% % third data with low volatility
% r = [0.05 0.05];     % risk free interest for each regime
% sigma = [0.3 0.4];   % volatility for each regime
% K = 10;              % asset price at expiration time
% T = 10;              % expiration time
% Q = [-3 3; 2 -2];    % regime generator matrix

Tol = 10^-4; rho = 0.95;
h = 0.05; dt = h^2; x_max = 3; % initialize with arbitrary time step
nx = x_max/h; nt = T/dt;   % rectangular domain of x and t (mesh)
m_r = dt/(h*h);   % mesh ratio

initial_sf = [K K]'; % initial exercise boundary;
sf_m(:,1) = initial_sf; % allocating first column to be the initial
                        % optimal exercise boundary 
for i = 1:nx+1
  U_old1(i) = 0; U_new1(i) = U_old1(i);  
  U_old2(i) = 0; U_new2(i) = U_old2(i); % intial condition for the option,  
  W_old1(i) = 0; W_new1(i) = W_old1(i); % value and delta in each regime 
  W_old2(i) = 0; W_new2(i) = W_old2(i); 
end

% begin: initialiazing discrete compact operator
for i=1:nx-1
    if i == 1
        B(1,1) = -24/h^2; B(1,2) = 12/h^2;
        N(1,1) = 14; N(1,2) = -5; N(1,3) = 4; N(1,4) = -1;
    elseif i == nx-1
        B(i,nx-2) = 12/h^2; B(i,nx-1) = -24/h^2;
        N(i,nx-1) = 14; N(i,nx-2) = -5; N(i,nx-3) = 4; N(i,nx-4) = -1;
    else
        B(i,i-1) = 12/h^2;
        B(i,i) = -24/h^2;
        B(i,i+1) = 12/h^2;
        N(i,i-1) = 1;
        N(i,i) = 10;
        N(i,i+1) = 1;
    end
end
% end: initialiazing discrete compact operator

% begin: initializing early exercise boundary for each regime
sf(1) = K; sf(2) = K;
% end: initializing early exercise boundary for each regime

% begin: initializing remaining parameters
ga = [(r(1)-0.5*sigma(1)^2) (r(2)-0.5*sigma(2)^2)];
mb1 = [(0.5*sigma(1)^2) (0.5*sigma(2)^2)];
mc1 = [(r(1)-Q(1,1)) (r(2)-Q(2,2))]; 

ah = 3*h; 
m1 = 81; m2 = -81/8; m3 = 1;
n1 = 255/4; n2 = 99/4; n3 = 9/2;

kk = 1; t = 0; rr = 0; dta = dt;
% end: initializing remaining parameters
tic
while t<T
    
    % begin.................................................
    nn = 0; 
    if t+dt>T
      dt = T-t;  % ensure that the t+dt<=T
    end
    % end.................................................
       
    while(1)
       
        % begin..........................................................
        [UL,WL,YL] = Zh(K,sf_m(:,kk),[U_old1;U_old2],[W_old1;W_old2],...
            [U_old1;U_old2],[W_old1;W_old2],h,r,sigma);
    
        Uh = [U_old1(4) U_old1(7) U_old1(10) U_old2(4) U_old2(7) ...
            U_old2(10)];
  
        mm = [sqrt((r(1)-Q(1,1))*K+Q(1,1)*sf_m(1,kk)-Q(1,2)*UL(2))/...
            sigma(1) sqrt((r(2)-Q(2,2))*K+Q(2,2)*sf_m(2,kk)-Q(2,1)*...
            UL(3))/sigma(2)];
    
        a1 = [((2*n3*mm(1)*ah^3)/(3*(sigma(1)^4)*sf_m(1,kk)^2)) ((2*n3*...
            mm(2)*ah^3)/(3*(sigma(2)^4)*sf_m(2,kk)^2))];
    
        b1 = [((((4*ga(1)*n3*mm(1)*ah^3)/(3*sigma(1)^4))-((2*n2*mm(1)*...
            ah^2)/(3*sigma(1)^2))-(n3*Q(1,1)*sf_m(1,kk)*ah^3)/(6*(mm(1))...
            *sigma(1)^4)+((n3*Q(1,2)*WL(2)*ah^3)/(6*(mm(1))*...
            sigma(1)^4)))/sf_m(1,kk)) ((((4*ga(2)*n3*mm(2)*ah^3)/(3*...
            sigma(2)^4))-((2*n2*mm(2)*ah^2)/(3*sigma(2)^2))-(n3*Q(2,2)*...
            sf_m(2,kk)*ah^3)/(6*(mm(2))*sigma(2)^4)+((n3*Q(2,1)*...
            WL(3)*ah^3)/(6*(mm(2))*sigma(2)^4)))/sf_m(2,kk))];  
        
        c1 = [(((2*(ga(1)^2)*n3*mm(1)*ah^3)/(3*sigma(1)^4))-(((2*n2*...
            mm(1)*ah^2)/(3*sigma(1)^2))+(n3*Q(1,1)*sf_m(1,kk)*ah^3)/...
            (6*(mm(1))*sigma(1)^4)-((n3*Q(1,2)*WL(2)*ah^3)/(6*...
            (mm(1))*sigma(1)^4)))*ga(1)-((3*n3*ah^3)/(4*mm(1)))*...
            ((((Q(1,1)^2)*sf_m(1,kk)^2)/(9*(mm(1)^2)*sigma(1)^4))+...
            (((Q(1,2)*WL(2))^2)/(9*(mm(1)^2)*sigma(1)^4))-((2*...
            Q(1,1)*sf_m(1,kk)*Q(1,2)*WL(2))/(9*(mm(1)^2)*...
            sigma(1)^4)))+((n2*ah^2)/(3*mm(1)*sigma(1)^2))*(Q(1,1)*...
            sf_m(1,kk)-Q(1,2)*WL(2))+((n3*mm(1)*(r(1)-Q(1,1))*...
            ah^3)/(2*sigma(1)))+((n3*ah^3)/(4*mm(1)*sigma(1)^2))*(Q(1,1)...
            *sf_m(1,kk)-Q(1,2)*YL(2))+n1*ah*mm(1)-m1*sqrt(Uh(1)-...
            K+exp(ah)*sf_m(1,kk))-m2*sqrt(Uh(2)-K+exp(2*ah)*sf_m(1,kk))-...
            m3*sqrt(Uh(3)-K+exp(3*ah)*sf_m(1,kk))) (((2*(ga(2)^2)*n3*...
            mm(2)*ah^3)/(3*sigma(2)^4))-(((2*n2*mm(2)*ah^2)/(3*sigma...
            (2)^2))+(n3*Q(2,2)*sf_m(2,kk)*ah^3)/(6*(mm(2))*sigma(2)^4)-...
            ((n3*Q(2,1)*WL(3)*ah^3)/(6*(mm(2))*sigma(2)^4)))*ga(2)...
            -((3*n3*ah^3)/(4*mm(2)))*((((Q(2,2)^2)*sf_m(2,kk)^2)/(9*...
            (mm(2)^2)*sigma(2)^4))+(((Q(2,1)*WL(3))^2)/(9*...
            (mm(2)^2)*sigma(2)^4))-((2*Q(2,2)*sf_m(2,kk)*Q(2,1)*...
            WL(3))/(9*(mm(2)^2)*sigma(2)^4)))+((n2*ah^2)/...
            (3*mm(2)*sigma(2)^2))*(Q(2,2)*sf_m(2,kk)-Q(2,1)*WL(3))...
            +((n3*mm(2)*(r(2)-Q(2,2))*ah^3)/(2*sigma(2)))+((n3*ah^3)/...
            (4*mm(2)*sigma(2)^2))*(Q(2,2)*sf_m(2,kk)-Q(2,1)*YL(3))...
            +n1*ah*mm(2)-m1*sqrt(Uh(4)-K+exp(ah)*sf_m(2,kk))-m2*...
            sqrt(Uh(5)-K+exp(2*ah)*sf_m(2,kk))-m3*sqrt(Uh(6)-K+exp(3*ah)...
            *sf_m(2,kk)))];
    
       Ra1 = [((-b1(1)-sqrt(b1(1)^2-4*a1(1)*c1(1)))/(2*a1(1))) ((-b1(2)...
           -sqrt(b1(2)^2-4*a1(2)*c1(2)))/(2*a1(2)))];
       
       sfa = [(sf_m(1,kk)+(dt/5)*Ra1(1)),(sf_m(2,kk)+(dt/5)*Ra1(2))]; 
       
       s1 = [Ra1(1)/sf_m(1,kk)+r(1)-((sigma(1))^2)/2 Ra1(2)/sf_m(2,kk)+...
           r(2)-((sigma(2))^2)/2];
       
       [U_oldL,W_oldL] = NewtHermite(K,sf_m(:,kk),[U_old1;U_old2],...
            [W_old1;W_old2],[U_old1;U_old2],[W_old1;W_old2],nx,h,x_max);

        Hu1(1) = 12*(K-sf_m(1,kk)); Hu2(1) = 12*(K-sf_m(2,kk)); 
        Hu1(nx-1) = 0; Hu2(nx-1) = 0;
        Hu1 = Hu1'; Hu2 = Hu2';
        
        Hw1(1) = -12*sf_m(1,kk);  Hw2(1) = -12*sf_m(2,kk);
        Hw1(nx-1) = 0; Hw2(nx-1) = 0;
        Hw1 = Hw1'; Hw2 = Hw2';
                
        Ru11 = (mb1(1))*(N\(B*U_old1(2:nx)'+(1/h^2)*Hu1))+s1(1)*W_old1...
            (2:nx)'-mc1(1)*U_old1(2:nx)'+Q(1,2)*U_oldL(2,2:nx)'; 
        Ru12 = (mb1(2))*(N\(B*U_old2(2:nx)'+(1/h^2)*Hu2))+s1(2)*W_old2...
            (2:nx)'-mc1(2)*U_old2(2:nx)'+Q(2,1)*U_oldL(3,2:nx)';  
        
        U11 = U_old1(2:nx)'+(dt/5)*Ru11; 
        U12 = U_old2(2:nx)'+(dt/5)*Ru12;
                
        Rw11 = (mb1(1))*(N\(B*W_old1(2:nx)'+(1/h^2)*Hw1))+s1(1)*(N\(B*...
            U_old1(2:nx)'+(1/h^2)*Hu1))-mc1(1)*W_old1(2:nx)'+Q(1,2)*...
            W_oldL(2,2:nx)';
        Rw12 = (mb1(2))*(N\(B*W_old2(2:nx)'+(1/h^2)*Hw2))+s1(2)*(N\(B*...
            U_old2(2:nx)'+(1/h^2)*Hu2))-mc1(2)*W_old2(2:nx)'+Q(2,1)*...
            W_oldL(3,2:nx)';
        
        W11 = W_old1(2:nx)'+(dt/5)*Rw11; 
        W12 = W_old2(2:nx)'+(dt/5)*Rw12;
        % end...........................................................

        % begin..........................................................        
        Uh = [U11(3) U11(6) U11(9) U12(3) U12(6) U12(9)];  
        Ua = [K-sfa(1),U11',0]; Ub = [K-sfa(2),U12',0]; 
        Wa = [-sfa(1),W11',0]; Wb = [-sfa(2),W12',0];
        [UL,WL,YL] = Zh(K,sfa,[Ua;Ub],[Wa;Wb],[U_old1;U_old2],...
            [W_old1;W_old2],h,r,sigma);
       
        mn = [sqrt((r(1)-Q(1,1))*K+Q(1,1)*sfa(1)-Q(1,2)*UL(2))/...
            sigma(1) sqrt((r(2)-Q(2,2))*K+Q(2,2)*sfa(2)-Q(2,1)*...
            UL(3))/sigma(2)];
    
        a2 = [((2*n3*mn(1)*ah^3)/(3*(sigma(1)^4)*sfa(1)^2)) ((2*n3*...
            mn(2)*ah^3)/(3*(sigma(2)^4)*sfa(2)^2))];
    
        b2 = [((((4*ga(1)*n3*mn(1)*ah^3)/(3*sigma(1)^4))-((2*n2*mn(1)*...
            ah^2)/(3*sigma(1)^2))-(n3*Q(1,1)*sfa(1)*ah^3)/(6*(mn(1))...
            *sigma(1)^4)+((n3*Q(1,2)*WL(2)*ah^3)/(6*(mn(1))*...
            sigma(1)^4)))/sfa(1)) ((((4*ga(2)*n3*mn(2)*ah^3)/(3*...
            sigma(2)^4))-((2*n2*mn(2)*ah^2)/(3*sigma(2)^2))-(n3*Q(2,2)*...
            sfa(2)*ah^3)/(6*(mn(2))*sigma(2)^4)+((n3*Q(2,1)*...
            WL(3)*ah^3)/(6*(mn(2))*sigma(2)^4)))/sfa(2))];  
        
        c2 = [(((2*(ga(1)^2)*n3*mn(1)*ah^3)/(3*sigma(1)^4))-(((2*n2*...
            mn(1)*ah^2)/(3*sigma(1)^2))+(n3*Q(1,1)*sfa(1)*ah^3)/...
            (6*(mn(1))*sigma(1)^4)-((n3*Q(1,2)*WL(2)*ah^3)/(6*...
            (mn(1))*sigma(1)^4)))*ga(1)-((3*n3*ah^3)/(4*mn(1)))*...
            ((((Q(1,1)^2)*sfa(1)^2)/(9*(mn(1)^2)*sigma(1)^4))+...
            (((Q(1,2)*WL(2))^2)/(9*(mn(1)^2)*sigma(1)^4))-((2*...
            Q(1,1)*sfa(1)*Q(1,2)*WL(2))/(9*(mn(1)^2)*...
            sigma(1)^4)))+((n2*ah^2)/(3*mn(1)*sigma(1)^2))*(Q(1,1)*...
            sfa(1)-Q(1,2)*WL(2))+((n3*mn(1)*(r(1)-Q(1,1))*...
            ah^3)/(2*sigma(1)))+((n3*ah^3)/(4*mn(1)*sigma(1)^2))*(Q(1,1)...
            *sfa(1)-Q(1,2)*YL(2))+n1*ah*mn(1)-m1*sqrt(Uh(1)-...
            K+exp(ah)*sfa(1))-m2*sqrt(Uh(2)-K+exp(2*ah)*sfa(1))-...
            m3*sqrt(Uh(3)-K+exp(3*ah)*sfa(1))) (((2*(ga(2)^2)*n3*...
            mn(2)*ah^3)/(3*sigma(2)^4))-(((2*n2*mn(2)*ah^2)/(3*sigma...
            (2)^2))+(n3*Q(2,2)*sfa(2)*ah^3)/(6*(mn(2))*sigma(2)^4)-...
            ((n3*Q(2,1)*WL(3)*ah^3)/(6*(mn(2))*sigma(2)^4)))*ga(2)...
            -((3*n3*ah^3)/(4*mn(2)))*((((Q(2,2)^2)*sfa(2)^2)/(9*...
            (mn(2)^2)*sigma(2)^4))+(((Q(2,1)*WL(3))^2)/(9*...
            (mn(2)^2)*sigma(2)^4))-((2*Q(2,2)*sfa(2)*Q(2,1)*...
            WL(3))/(9*(mn(2)^2)*sigma(2)^4)))+((n2*ah^2)/...
            (3*mn(2)*sigma(2)^2))*(Q(2,2)*sfa(2)-Q(2,1)*WL(3))...
            +((n3*mn(2)*(r(2)-Q(2,2))*ah^3)/(2*sigma(2)))+((n3*ah^3)/...
            (4*mn(2)*sigma(2)^2))*(Q(2,2)*sfa(2)-Q(2,1)*YL(3))...
            +n1*ah*mn(2)-m1*sqrt(Uh(4)-K+exp(ah)*sfa(2))-m2*...
            sqrt(Uh(5)-K+exp(2*ah)*sfa(2))-m3*sqrt(Uh(6)-K+exp(3*ah)...
            *sfa(2)))];
    
        Ra2 = [((-b2(1)-sqrt(b2(1)^2-4*a2(1)*c2(1)))/(2*a2(1))) ((-b2(2)...
           -sqrt(b2(2)^2-4*a2(2)*c2(2)))/(2*a2(2)))];
       
        sfb = [(sf_m(1,kk)+dt*((3/40)*Ra1(1)+(9/40)*Ra2(1))) ...
            (sf_m(2,kk)+dt*((3/40)*Ra1(2)+(9/40)*Ra2(2)))]; 
       
        s1 = [Ra2(1)/sfa(1)+r(1)-((sigma(1))^2)/2 Ra2(2)/sfa(2)+r(2)-...
           ((sigma(2))^2)/2];  
       
        [U_oldL,W_oldL] = NewtHermite(K,sfa,[Ua;Ub],[Wa;Wb]...
            ,[U_old1;U_old2],[W_old1;W_old2],nx,h,x_max);
        
        Iu1(1) = 12*(K-sfa(1)); Iu2(1) = 12*(K-sfa(2)); 
        Iu1(nx-1) = 0; Iu2(nx-1) = 0;
        Iu1 = Iu1'; Iu2 = Iu2';
        
        Iw1(1) = -12*sfa(1);  Iw2(1) = -12*sfa(2);
        Iw1(nx-1) = 0; Iw2(nx-1) = 0;
        Iw1 = Iw1'; Iw2 = Iw2';
        
        Ru21 = (mb1(1))*(N\(B*U11+(1/h^2)*Iu1))+s1(1)*W11-mc1(1)*U11+...
            Q(1,2)*U_oldL(2,2:nx)'; 
        Ru22 = (mb1(2))*(N\(B*U12+(1/h^2)*Iu2))+s1(2)*W12-mc1(2)*U12+...
            Q(2,1)*U_oldL(3,2:nx)';
        
        U21 = U_old1(2:nx)'+dt*((3/40)*Ru11+(9/40)*Ru21);
        U22 = U_old2(2:nx)'+dt*((3/40)*Ru12+(9/40)*Ru22);
        
        Rw21 = (mb1(1))*(N\(B*W11+(1/h^2)*Iw1))+s1(1)*(N\(B*U11+(1/h^2)...
            *Iu1))-mc1(1)*W11+Q(1,2)*W_oldL(2,2:nx)';
        Rw22 = (mb1(2))*(N\(B*W12+(1/h^2)*Iw2))+s1(2)*(N\(B*U12+(1/h^2)...
            *Iu2))-mc1(2)*W12+Q(2,1)*W_oldL(3,2:nx)';
        
        W21 = W_old1(2:nx)'+dt*((3/40)*Rw11+(9/40)*Rw21);
        W22 = W_old2(2:nx)'+dt*((3/40)*Rw12+(9/40)*Rw22);
        % end........................................................... 
    
        % begin...........................................................
        Ua = [K-sfb(1),U21',0]; Ub = [K-sfb(2),U22',0]; 
        Wa = [-sfb(1),W21',0]; Wb = [-sfb(2),W22',0];
        
        Uh = [U21(3) U21(6) U21(9) U22(3) U22(6) U22(9)];        
        [UL,WL,YL] = Zh(K,sfb,[Ua;Ub],[Wa;Wb],[U_old1;U_old2],...
            [W_old1;W_old2],h,r,sigma);
        
        mp = [sqrt((r(1)-Q(1,1))*K+Q(1,1)*sfb(1)-Q(1,2)*UL(2))/...
            sigma(1) sqrt((r(2)-Q(2,2))*K+Q(2,2)*sfb(2)-Q(2,1)*...
            UL(3))/sigma(2)];
    
        a3 = [((2*n3*mp(1)*ah^3)/(3*(sigma(1)^4)*sfb(1)^2)) ((2*n3*...
            mp(2)*ah^3)/(3*(sigma(2)^4)*sfb(2)^2))];
    
        b3 = [((((4*ga(1)*n3*mp(1)*ah^3)/(3*sigma(1)^4))-((2*n2*mp(1)*...
            ah^2)/(3*sigma(1)^2))-(n3*Q(1,1)*sfb(1)*ah^3)/(6*(mp(1))...
            *sigma(1)^4)+((n3*Q(1,2)*WL(2)*ah^3)/(6*(mp(1))*...
            sigma(1)^4)))/sfb(1)) ((((4*ga(2)*n3*mp(2)*ah^3)/(3*...
            sigma(2)^4))-((2*n2*mp(2)*ah^2)/(3*sigma(2)^2))-(n3*Q(2,2)*...
            sfb(2)*ah^3)/(6*(mp(2))*sigma(2)^4)+((n3*Q(2,1)*...
            WL(3)*ah^3)/(6*(mp(2))*sigma(2)^4)))/sfb(2))];  
        
        c3 = [(((2*(ga(1)^2)*n3*mp(1)*ah^3)/(3*sigma(1)^4))-(((2*n2*...
            mp(1)*ah^2)/(3*sigma(1)^2))+(n3*Q(1,1)*sfb(1)*ah^3)/...
            (6*(mp(1))*sigma(1)^4)-((n3*Q(1,2)*WL(2)*ah^3)/(6*...
            (mp(1))*sigma(1)^4)))*ga(1)-((3*n3*ah^3)/(4*mp(1)))*...
            ((((Q(1,1)^2)*sfb(1)^2)/(9*(mp(1)^2)*sigma(1)^4))+...
            (((Q(1,2)*WL(2))^2)/(9*(mp(1)^2)*sigma(1)^4))-((2*...
            Q(1,1)*sfb(1)*Q(1,2)*WL(2))/(9*(mp(1)^2)*...
            sigma(1)^4)))+((n2*ah^2)/(3*mp(1)*sigma(1)^2))*(Q(1,1)*...
            sfb(1)-Q(1,2)*WL(2))+((n3*mp(1)*(r(1)-Q(1,1))*...
            ah^3)/(2*sigma(1)))+((n3*ah^3)/(4*mp(1)*sigma(1)^2))*(Q(1,1)...
            *sfb(1)-Q(1,2)*YL(2))+n1*ah*mp(1)-m1*sqrt(Uh(1)-...
            K+exp(ah)*sfb(1))-m2*sqrt(Uh(2)-K+exp(2*ah)*sfb(1))-...
            m3*sqrt(Uh(3)-K+exp(3*ah)*sfb(1))) (((2*(ga(2)^2)*n3*...
            mp(2)*ah^3)/(3*sigma(2)^4))-(((2*n2*mp(2)*ah^2)/(3*sigma...
            (2)^2))+(n3*Q(2,2)*sfb(2)*ah^3)/(6*(mp(2))*sigma(2)^4)-...
            ((n3*Q(2,1)*WL(3)*ah^3)/(6*(mp(2))*sigma(2)^4)))*ga(2)...
            -((3*n3*ah^3)/(4*mp(2)))*((((Q(2,2)^2)*sfb(2)^2)/(9*...
            (mp(2)^2)*sigma(2)^4))+(((Q(2,1)*WL(3))^2)/(9*...
            (mp(2)^2)*sigma(2)^4))-((2*Q(2,2)*sfb(2)*Q(2,1)*...
            WL(3))/(9*(mp(2)^2)*sigma(2)^4)))+((n2*ah^2)/...
            (3*mp(2)*sigma(2)^2))*(Q(2,2)*sfb(2)-Q(2,1)*WL(3))...
            +((n3*mp(2)*(r(2)-Q(2,2))*ah^3)/(2*sigma(2)))+((n3*ah^3)/...
            (4*mp(2)*sigma(2)^2))*(Q(2,2)*sfb(2)-Q(2,1)*YL(3))...
            +n1*ah*mp(2)-m1*sqrt(Uh(4)-K+exp(ah)*sfb(2))-m2*...
            sqrt(Uh(5)-K+exp(2*ah)*sfb(2))-m3*sqrt(Uh(6)-K+exp(3*ah)...
            *sfb(2)))];
    
        Ra3 = [((-b3(1)-sqrt(b3(1)^2-4*a3(1)*c3(1)))/(2*a3(1))) ((-b3(2)...
           -sqrt(b3(2)^2-4*a3(2)*c3(2)))/(2*a3(2)))];
       
        sfc = [(sf_m(1,kk)+dt*((44/45)*Ra1(1)-(56/15)*Ra2(1)+(32/9)...
            *Ra3(1))) (sf_m(2,kk)+dt*((44/45)*Ra1(2)-(56/15)*Ra2(2)+...
            (32/9)*Ra3(2)))]; 

        s1 = [(Ra3(1)/sfb(1)+r(1)-((sigma(1))^2)/2) Ra3(2)/sfb(2)+...
           r(2)-((sigma(2))^2)/2];       
       
        [U_oldL,W_oldL] = NewtHermite(K,sfb,[Ua;Ub],[Wa;Wb]...
            ,[U_old1;U_old2],[W_old1;W_old2],nx,h,x_max);
        
        Ju1(1) = 12*(K-sfb(1)); Ju2(1) = 12*(K-sfb(2)); 
        Ju1(nx-1) = 0; Ju2(nx-1) = 0;
        Ju1 = Ju1'; Ju2 = Ju2';
        
        Jw1(1) = -12*sfb(1);  Jw2(1) = -12*sfb(2);
        Jw1(nx-1) = 0; Jw2(nx-1) = 0;
        Jw1 = Jw1'; Jw2 = Jw2';
        
        Ru31 = (mb1(1))*(N\(B*U21+(1/h^2)*Ju1))+s1(1)*W21-mc1(1)*U21+...
            Q(1,2)*U_oldL(2,2:nx)'; 
        Ru32 = (mb1(2))*(N\(B*U22+(1/h^2)*Ju2))+s1(2)*W22-mc1(2)*U22+...
            Q(2,1)*U_oldL(3,2:nx)';  
        
        U31 = U_old1(2:nx)'+dt*((44/45)*Ru11-(56/15)*Ru21+(32/9)*Ru31);
        U32 = U_old2(2:nx)'+dt*((44/45)*Ru12-(56/15)*Ru22+(32/9)*Ru32);
        
        Rw31 = (mb1(1))*(N\(B*W21+(1/h^2)*Jw1))+s1(1)*(N\(B*U21+...
            (1/h^2)*Ju1))-mc1(1)*W21+Q(1,2)*W_oldL(2,2:nx)';
        Rw32 = (mb1(2))*(N\(B*W22+(1/h^2)*Jw2))+s1(2)*(N\(B*U22+...
            (1/h^2)*Ju2))-mc1(2)*W22+Q(2,1)*W_oldL(3,2:nx)';
        
        W31 = W_old1(2:nx)'+dt*((44/45)*Rw11-(56/15)*Rw21+(32/9)*Rw31);
        W32 = W_old2(2:nx)'+dt*((44/45)*Rw12-(56/15)*Rw22+(32/9)*Rw32);
        % end............................................................

        % begin...........................................................
        Ua = [K-sfc(1),U31',0]; Ub = [K-sfc(2),U32',0]; 
        Wa = [-sfc(1),W31',0]; Wb = [-sfc(2),W32',0];
        
        Uh = [U31(3) U31(6) U31(9) U32(3) U32(6) U32(9)];        
        [UL,WL,YL] = Zh(K,sfc,[Ua;Ub],[Wa;Wb],[U_old1;U_old2],...
            [W_old1;W_old2],h,r,sigma);
        
        mq = [sqrt((r(1)-Q(1,1))*K+Q(1,1)*sfc(1)-Q(1,2)*UL(2))/...
            sigma(1) sqrt((r(2)-Q(2,2))*K+Q(2,2)*sfc(2)-Q(2,1)*...
            UL(3))/sigma(2)];
    
        a3 = [((2*n3*mq(1)*ah^3)/(3*(sigma(1)^4)*sfc(1)^2)) ((2*n3*...
            mq(2)*ah^3)/(3*(sigma(2)^4)*sfc(2)^2))];
    
        b3 = [((((4*ga(1)*n3*mq(1)*ah^3)/(3*sigma(1)^4))-((2*n2*mq(1)*...
            ah^2)/(3*sigma(1)^2))-(n3*Q(1,1)*sfc(1)*ah^3)/(6*(mq(1))...
            *sigma(1)^4)+((n3*Q(1,2)*WL(2)*ah^3)/(6*(mq(1))*...
            sigma(1)^4)))/sfc(1)) ((((4*ga(2)*n3*mq(2)*ah^3)/(3*...
            sigma(2)^4))-((2*n2*mq(2)*ah^2)/(3*sigma(2)^2))-(n3*Q(2,2)*...
            sfc(2)*ah^3)/(6*(mq(2))*sigma(2)^4)+((n3*Q(2,1)*...
            WL(3)*ah^3)/(6*(mq(2))*sigma(2)^4)))/sfc(2))];  
        
        c3 = [(((2*(ga(1)^2)*n3*mq(1)*ah^3)/(3*sigma(1)^4))-(((2*n2*...
            mq(1)*ah^2)/(3*sigma(1)^2))+(n3*Q(1,1)*sfc(1)*ah^3)/...
            (6*(mq(1))*sigma(1)^4)-((n3*Q(1,2)*WL(2)*ah^3)/(6*...
            (mq(1))*sigma(1)^4)))*ga(1)-((3*n3*ah^3)/(4*mq(1)))*...
            ((((Q(1,1)^2)*sfc(1)^2)/(9*(mq(1)^2)*sigma(1)^4))+...
            (((Q(1,2)*WL(2))^2)/(9*(mq(1)^2)*sigma(1)^4))-((2*...
            Q(1,1)*sfc(1)*Q(1,2)*WL(2))/(9*(mq(1)^2)*...
            sigma(1)^4)))+((n2*ah^2)/(3*mq(1)*sigma(1)^2))*(Q(1,1)*...
            sfc(1)-Q(1,2)*WL(2))+((n3*mq(1)*(r(1)-Q(1,1))*...
            ah^3)/(2*sigma(1)))+((n3*ah^3)/(4*mq(1)*sigma(1)^2))*(Q(1,1)...
            *sfc(1)-Q(1,2)*YL(2))+n1*ah*mq(1)-m1*sqrt(Uh(1)-...
            K+exp(ah)*sfc(1))-m2*sqrt(Uh(2)-K+exp(2*ah)*sfc(1))-...
            m3*sqrt(Uh(3)-K+exp(3*ah)*sfc(1))) (((2*(ga(2)^2)*n3*...
            mq(2)*ah^3)/(3*sigma(2)^4))-(((2*n2*mq(2)*ah^2)/(3*sigma...
            (2)^2))+(n3*Q(2,2)*sfc(2)*ah^3)/(6*(mq(2))*sigma(2)^4)-...
            ((n3*Q(2,1)*WL(3)*ah^3)/(6*(mq(2))*sigma(2)^4)))*ga(2)...
            -((3*n3*ah^3)/(4*mq(2)))*((((Q(2,2)^2)*sfc(2)^2)/(9*...
            (mq(2)^2)*sigma(2)^4))+(((Q(2,1)*WL(3))^2)/(9*...
            (mq(2)^2)*sigma(2)^4))-((2*Q(2,2)*sfc(2)*Q(2,1)*...
            WL(3))/(9*(mq(2)^2)*sigma(2)^4)))+((n2*ah^2)/...
            (3*mq(2)*sigma(2)^2))*(Q(2,2)*sfc(2)-Q(2,1)*WL(3))...
            +((n3*mq(2)*(r(2)-Q(2,2))*ah^3)/(2*sigma(2)))+((n3*ah^3)/...
            (4*mq(2)*sigma(2)^2))*(Q(2,2)*sfc(2)-Q(2,1)*YL(3))...
            +n1*ah*mq(2)-m1*sqrt(Uh(4)-K+exp(ah)*sfc(2))-m2*...
            sqrt(Uh(5)-K+exp(2*ah)*sfc(2))-m3*sqrt(Uh(6)-K+exp(3*ah)...
            *sfc(2)))];
    
        Ra4 = [((-b3(1)-sqrt(b3(1)^2-4*a3(1)*c3(1)))/(2*a3(1))) ((-b3(2)...
           -sqrt(b3(2)^2-4*a3(2)*c3(2)))/(2*a3(2)))];
       
        sfd = [(sf_m(1,kk)+dt*((19372/6561)*Ra1(1)-(25360/2187)*Ra2(1)+...
            (64448/6561)*Ra3(1)-(212/729)*Ra4(1))) (sf_m(2,kk)+dt*...
            ((19372/6561)*Ra1(2)-(25360/2187)*Ra2(2)+(64448/6561)*Ra3(2)...
            -(212/729)*Ra4(2)))]; 

        s1 = [(Ra4(1)/sfc(1)+r(1)-((sigma(1))^2)/2) Ra4(2)/sfc(2)+...
           r(2)-((sigma(2))^2)/2];       
       
        [U_oldL,W_oldL] = NewtHermite(K,sfc,[Ua;Ub],[Wa;Wb]...
            ,[U_old1;U_old2],[W_old1;W_old2],nx,h,x_max);
        
        Ku1(1) = 12*(K-sfc(1)); Ku2(1) = 12*(K-sfc(2)); 
        Ku1(nx-1) = 0; Ku2(nx-1) = 0;
        Ku1 = Ku1'; Ku2 = Ku2';
        
        Kw1(1) = -12*sfc(1);  Kw2(1) = -12*sfc(2);
        Kw1(nx-1) = 0; Kw2(nx-1) = 0;
        Kw1 = Kw1'; Kw2 = Kw2';
        
        Ru41 = (mb1(1))*(N\(B*U31+(1/h^2)*Ku1))+s1(1)*W31-mc1(1)*U31+...
            Q(1,2)*U_oldL(2,2:nx)'; 
        Ru42 = (mb1(2))*(N\(B*U32+(1/h^2)*Ku2))+s1(2)*W32-mc1(2)*U32+...
            Q(2,1)*U_oldL(3,2:nx)';  
        
        U41 = U_old1(2:nx)'+dt*((19372/6561)*Ru11-(25360/2187)*Ru21+...
            (64448/6561)*Ru31-(212/729)*Ru41);
        U42 = U_old2(2:nx)'+dt*((19372/6561)*Ru12-(25360/2187)*Ru22+...
            (64448/6561)*Ru32-(212/729)*Ru42);
        
        Rw41 = (mb1(1))*(N\(B*W31+(1/h^2)*Kw1))+s1(1)*(N\(B*U31+...
            (1/h^2)*Ku1))-mc1(1)*W31+Q(1,2)*W_oldL(2,2:nx)';
        Rw42 = (mb1(2))*(N\(B*W32+(1/h^2)*Kw2))+s1(2)*(N\(B*U32+...
            (1/h^2)*Ku2))-mc1(2)*W32+Q(2,1)*W_oldL(3,2:nx)';
        
        W41 = W_old1(2:nx)'+dt*((19372/6561)*Rw11-(25360/2187)*Rw21+...
            (64448/6561)*Rw31-(212/729)*Rw41);
        W42 = W_old2(2:nx)'+dt*((19372/6561)*Rw12-(25360/2187)*Rw22+...
            (64448/6561)*Rw32-(212/729)*Rw42);
        % end............................................................

        % begin...........................................................
        Ua = [K-sfd(1),U41',0]; Ub = [K-sfd(2),U42',0]; 
        Wa = [-sfd(1),W41',0]; Wb = [-sfd(2),W42',0];
        
        Uh = [U41(3) U41(6) U41(9) U42(3) U42(6) U42(9)];        
        [UL,WL,YL] = Zh(K,sfd,[Ua;Ub],[Wa;Wb],[U_old1;U_old2],...
            [W_old1;W_old2],h,r,sigma);
        
        mr = [sqrt((r(1)-Q(1,1))*K+Q(1,1)*sfd(1)-Q(1,2)*UL(2))/...
            sigma(1) sqrt((r(2)-Q(2,2))*K+Q(2,2)*sfd(2)-Q(2,1)*...
            UL(3))/sigma(2)];
    
        a3 = [((2*n3*mr(1)*ah^3)/(3*(sigma(1)^4)*sfd(1)^2)) ((2*n3*...
            mr(2)*ah^3)/(3*(sigma(2)^4)*sfd(2)^2))];
    
        b3 = [((((4*ga(1)*n3*mr(1)*ah^3)/(3*sigma(1)^4))-((2*n2*mr(1)*...
            ah^2)/(3*sigma(1)^2))-(n3*Q(1,1)*sfd(1)*ah^3)/(6*(mr(1))...
            *sigma(1)^4)+((n3*Q(1,2)*WL(2)*ah^3)/(6*(mr(1))*...
            sigma(1)^4)))/sfd(1)) ((((4*ga(2)*n3*mr(2)*ah^3)/(3*...
            sigma(2)^4))-((2*n2*mr(2)*ah^2)/(3*sigma(2)^2))-(n3*Q(2,2)*...
            sfd(2)*ah^3)/(6*(mr(2))*sigma(2)^4)+((n3*Q(2,1)*...
            WL(3)*ah^3)/(6*(mr(2))*sigma(2)^4)))/sfd(2))];  
        
        c3 = [(((2*(ga(1)^2)*n3*mr(1)*ah^3)/(3*sigma(1)^4))-(((2*n2*...
            mr(1)*ah^2)/(3*sigma(1)^2))+(n3*Q(1,1)*sfd(1)*ah^3)/...
            (6*(mr(1))*sigma(1)^4)-((n3*Q(1,2)*WL(2)*ah^3)/(6*...
            (mr(1))*sigma(1)^4)))*ga(1)-((3*n3*ah^3)/(4*mr(1)))*...
            ((((Q(1,1)^2)*sfd(1)^2)/(9*(mr(1)^2)*sigma(1)^4))+...
            (((Q(1,2)*WL(2))^2)/(9*(mr(1)^2)*sigma(1)^4))-((2*...
            Q(1,1)*sfd(1)*Q(1,2)*WL(2))/(9*(mr(1)^2)*...
            sigma(1)^4)))+((n2*ah^2)/(3*mr(1)*sigma(1)^2))*(Q(1,1)*...
            sfd(1)-Q(1,2)*WL(2))+((n3*mr(1)*(r(1)-Q(1,1))*...
            ah^3)/(2*sigma(1)))+((n3*ah^3)/(4*mr(1)*sigma(1)^2))*(Q(1,1)...
            *sfd(1)-Q(1,2)*YL(2))+n1*ah*mr(1)-m1*sqrt(Uh(1)-...
            K+exp(ah)*sfd(1))-m2*sqrt(Uh(2)-K+exp(2*ah)*sfd(1))-...
            m3*sqrt(Uh(3)-K+exp(3*ah)*sfd(1))) (((2*(ga(2)^2)*n3*...
            mr(2)*ah^3)/(3*sigma(2)^4))-(((2*n2*mr(2)*ah^2)/(3*sigma...
            (2)^2))+(n3*Q(2,2)*sfd(2)*ah^3)/(6*(mr(2))*sigma(2)^4)-...
            ((n3*Q(2,1)*WL(3)*ah^3)/(6*(mr(2))*sigma(2)^4)))*ga(2)...
            -((3*n3*ah^3)/(4*mr(2)))*((((Q(2,2)^2)*sfd(2)^2)/(9*...
            (mr(2)^2)*sigma(2)^4))+(((Q(2,1)*WL(3))^2)/(9*...
            (mr(2)^2)*sigma(2)^4))-((2*Q(2,2)*sfd(2)*Q(2,1)*...
            WL(3))/(9*(mr(2)^2)*sigma(2)^4)))+((n2*ah^2)/...
            (3*mr(2)*sigma(2)^2))*(Q(2,2)*sfd(2)-Q(2,1)*WL(3))...
            +((n3*mr(2)*(r(2)-Q(2,2))*ah^3)/(2*sigma(2)))+((n3*ah^3)/...
            (4*mr(2)*sigma(2)^2))*(Q(2,2)*sfd(2)-Q(2,1)*YL(3))...
            +n1*ah*mr(2)-m1*sqrt(Uh(4)-K+exp(ah)*sfd(2))-m2*...
            sqrt(Uh(5)-K+exp(2*ah)*sfd(2))-m3*sqrt(Uh(6)-K+exp(3*ah)...
            *sfd(2)))];
    
        Ra5 = [((-b3(1)-sqrt(b3(1)^2-4*a3(1)*c3(1)))/(2*a3(1))) ((-b3(2)...
           -sqrt(b3(2)^2-4*a3(2)*c3(2)))/(2*a3(2)))];
       
        sfe = [(sf_m(1,kk)+dt*((9017/3168)*Ra1(1)-(355/33)*Ra2(1)+...
            (46732/5247)*Ra3(1)+(49/176)*Ra4(1)-(5103/18656)*Ra5(1))) ...
            (sf_m(2,kk)+dt*((9017/3168)*Ra1(2)-(355/33)*Ra2(2)+...
            (46732/5247)*Ra3(2)+(49/176)*Ra4(2)-(5103/18656)*Ra5(2)))]; 

        s1 = [(Ra5(1)/sfd(1)+r(1)-((sigma(1))^2)/2) Ra5(2)/sfd(2)+...
           r(2)-((sigma(2))^2)/2];       
       
        [U_oldL,W_oldL] = NewtHermite(K,sfd,[Ua;Ub],[Wa;Wb]...
            ,[U_old1;U_old2],[W_old1;W_old2],nx,h,x_max);
        
        Lu1(1) = 12*(K-sfd(1)); Lu2(1) = 12*(K-sfd(2)); 
        Lu1(nx-1) = 0; Lu2(nx-1) = 0;
        Lu1 = Lu1'; Lu2 = Lu2';
        
        Lw1(1) = -12*sfd(1);  Lw2(1) = -12*sfd(2);
        Lw1(nx-1) = 0; Lw2(nx-1) = 0;
        Lw1 = Lw1'; Lw2 = Lw2';
        
        Ru51 = (mb1(1))*(N\(B*U41+(1/h^2)*Lu1))+s1(1)*W41-mc1(1)*U41+...
            Q(1,2)*U_oldL(2,2:nx)'; 
        Ru52 = (mb1(2))*(N\(B*U42+(1/h^2)*Lu2))+s1(2)*W42-mc1(2)*U42+...
            Q(2,1)*U_oldL(3,2:nx)';  
        
        U51 = U_old1(2:nx)'+dt*((9017/3168)*Ru11-(355/33)*Ru21+...
            (46732/5247)*Ru31+(49/176)*Ru41-(5103/18656)*Ru51);
        U52 = U_old2(2:nx)'+dt*((9017/3168)*Ru12-(355/33)*Ru22+...
            (46732/5247)*Ru32+(49/176)*Ru42-(5103/18656)*Ru52);
        
        Rw51 = (mb1(1))*(N\(B*W41+(1/h^2)*Lw1))+s1(1)*(N\(B*U41+...
            (1/h^2)*Lu1))-mc1(1)*W41+Q(1,2)*W_oldL(2,2:nx)';
        Rw52 = (mb1(2))*(N\(B*W42+(1/h^2)*Lw2))+s1(2)*(N\(B*U42+...
            (1/h^2)*Lu2))-mc1(2)*W42+Q(2,1)*W_oldL(3,2:nx)';
        
        W51 = W_old1(2:nx)'+dt*((9017/3168)*Rw11-(355/33)*Rw21+...
            (46732/5247)*Rw31+(49/176)*Rw41-(5103/18656)*Rw51);
        W52 = W_old2(2:nx)'+dt*((9017/3168)*Rw12-(355/33)*Rw22+...
            (46732/5247)*Rw32+(49/176)*Rw42-(5103/18656)*Rw52);
        % end............................................................


        % begin...........................................................
        Ua = [K-sfe(1),U51',0]; Ub = [K-sfe(2),U52',0]; 
        Wa = [-sfe(1),W51',0]; Wb = [-sfe(2),W52',0];
        
        Uh = [U51(3) U51(6) U51(9) U52(3) U52(6) U52(9)];        
        [UL,WL,YL] = Zh(K,sfe,[Ua;Ub],[Wa;Wb],[U_old1;U_old2],...
            [W_old1;W_old2],h,r,sigma);
        
        ms = [sqrt((r(1)-Q(1,1))*K+Q(1,1)*sfe(1)-Q(1,2)*UL(2))/...
            sigma(1) sqrt((r(2)-Q(2,2))*K+Q(2,2)*sfe(2)-Q(2,1)*...
            UL(3))/sigma(2)];
    
        a3 = [((2*n3*ms(1)*ah^3)/(3*(sigma(1)^4)*sfe(1)^2)) ((2*n3*...
            ms(2)*ah^3)/(3*(sigma(2)^4)*sfe(2)^2))];
    
        b3 = [((((4*ga(1)*n3*ms(1)*ah^3)/(3*sigma(1)^4))-((2*n2*ms(1)*...
            ah^2)/(3*sigma(1)^2))-(n3*Q(1,1)*sfe(1)*ah^3)/(6*(ms(1))...
            *sigma(1)^4)+((n3*Q(1,2)*WL(2)*ah^3)/(6*(ms(1))*...
            sigma(1)^4)))/sfe(1)) ((((4*ga(2)*n3*ms(2)*ah^3)/(3*...
            sigma(2)^4))-((2*n2*ms(2)*ah^2)/(3*sigma(2)^2))-(n3*Q(2,2)*...
            sfe(2)*ah^3)/(6*(ms(2))*sigma(2)^4)+((n3*Q(2,1)*...
            WL(3)*ah^3)/(6*(ms(2))*sigma(2)^4)))/sfe(2))];  
        
        c3 = [(((2*(ga(1)^2)*n3*ms(1)*ah^3)/(3*sigma(1)^4))-(((2*n2*...
            ms(1)*ah^2)/(3*sigma(1)^2))+(n3*Q(1,1)*sfe(1)*ah^3)/...
            (6*(ms(1))*sigma(1)^4)-((n3*Q(1,2)*WL(2)*ah^3)/(6*...
            (ms(1))*sigma(1)^4)))*ga(1)-((3*n3*ah^3)/(4*ms(1)))*...
            ((((Q(1,1)^2)*sfe(1)^2)/(9*(ms(1)^2)*sigma(1)^4))+...
            (((Q(1,2)*WL(2))^2)/(9*(ms(1)^2)*sigma(1)^4))-((2*...
            Q(1,1)*sfe(1)*Q(1,2)*WL(2))/(9*(ms(1)^2)*...
            sigma(1)^4)))+((n2*ah^2)/(3*ms(1)*sigma(1)^2))*(Q(1,1)*...
            sfe(1)-Q(1,2)*WL(2))+((n3*ms(1)*(r(1)-Q(1,1))*...
            ah^3)/(2*sigma(1)))+((n3*ah^3)/(4*ms(1)*sigma(1)^2))*(Q(1,1)...
            *sfe(1)-Q(1,2)*YL(2))+n1*ah*ms(1)-m1*sqrt(Uh(1)-...
            K+exp(ah)*sfe(1))-m2*sqrt(Uh(2)-K+exp(2*ah)*sfe(1))-...
            m3*sqrt(Uh(3)-K+exp(3*ah)*sfe(1))) (((2*(ga(2)^2)*n3*...
            ms(2)*ah^3)/(3*sigma(2)^4))-(((2*n2*ms(2)*ah^2)/(3*sigma...
            (2)^2))+(n3*Q(2,2)*sfe(2)*ah^3)/(6*(ms(2))*sigma(2)^4)-...
            ((n3*Q(2,1)*WL(3)*ah^3)/(6*(ms(2))*sigma(2)^4)))*ga(2)...
            -((3*n3*ah^3)/(4*ms(2)))*((((Q(2,2)^2)*sfe(2)^2)/(9*...
            (ms(2)^2)*sigma(2)^4))+(((Q(2,1)*WL(3))^2)/(9*...
            (ms(2)^2)*sigma(2)^4))-((2*Q(2,2)*sfe(2)*Q(2,1)*...
            WL(3))/(9*(ms(2)^2)*sigma(2)^4)))+((n2*ah^2)/...
            (3*ms(2)*sigma(2)^2))*(Q(2,2)*sfe(2)-Q(2,1)*WL(3))...
            +((n3*ms(2)*(r(2)-Q(2,2))*ah^3)/(2*sigma(2)))+((n3*ah^3)/...
            (4*ms(2)*sigma(2)^2))*(Q(2,2)*sfe(2)-Q(2,1)*YL(3))...
            +n1*ah*ms(2)-m1*sqrt(Uh(4)-K+exp(ah)*sfe(2))-m2*...
            sqrt(Uh(5)-K+exp(2*ah)*sfe(2))-m3*sqrt(Uh(6)-K+exp(3*ah)...
            *sfe(2)))];

        Ra6 = [((-b3(1)-sqrt(b3(1)^2-4*a3(1)*c3(1)))/(2*a3(1))) ((-b3(2)...
           -sqrt(b3(2)^2-4*a3(2)*c3(2)))/(2*a3(2)))];
       
        sff = [(sf_m(1,kk)+dt*((35/384)*Ra1(1)+(500/1113)*Ra3(1)+...
            (125/192)*Ra4(1)-(2187/6784)*Ra5(1)+(11/84)*Ra6(1))) ...
            (sf_m(2,kk)+dt*((35/384)*Ra1(2)+(500/1113)*Ra3(2)+...
            (125/192)*Ra4(2)-(2187/6784)*Ra5(2)+(11/84)*Ra6(2)))]; 

        s1 = [(Ra6(1)/sfe(1)+r(1)-((sigma(1))^2)/2) Ra6(2)/sfe(2)+...
           r(2)-((sigma(2))^2)/2];       
       
        [U_oldL,W_oldL] = NewtHermite(K,sfe,[Ua;Ub],[Wa;Wb]...
            ,[U_old1;U_old2],[W_old1;W_old2],nx,h,x_max);
        
        Mu1(1) = 12*(K-sfe(1)); Mu2(1) = 12*(K-sfe(2)); 
        Mu1(nx-1) = 0; Mu2(nx-1) = 0;
        Mu1 = Mu1'; Mu2 = Mu2';
        
        Mw1(1) = -12*sfe(1);  Mw2(1) = -12*sfe(2);
        Mw1(nx-1) = 0; Mw2(nx-1) = 0;
        Mw1 = Mw1'; Mw2 = Mw2';
        
        Ru61 = (mb1(1))*(N\(B*U51+(1/h^2)*Mu1))+s1(1)*W51-mc1(1)*U51+...
            Q(1,2)*U_oldL(2,2:nx)'; 
        Ru62 = (mb1(2))*(N\(B*U52+(1/h^2)*Mu2))+s1(2)*W52-mc1(2)*U52+...
            Q(2,1)*U_oldL(3,2:nx)';  
        
        U61 = U_old1(2:nx)'+dt*((35/384)*Ru11+(500/1113)*Ru31+(125/192)...
            *Ru41-(2187/6784)*Ru51+(11/84)*Ru61);
        U62 = U_old2(2:nx)'+dt*((35/384)*Ru12+(500/1113)*Ru32+(125/192)...
            *Ru42-(2187/6784)*Ru52+(11/84)*Ru62);
        
        Rw61 = (mb1(1))*(N\(B*W51+(1/h^2)*Mw1))+s1(1)*(N\(B*U51+...
            (1/h^2)*Mu1))-mc1(1)*W51+Q(1,2)*W_oldL(2,2:nx)';
        Rw62 = (mb1(2))*(N\(B*W52+(1/h^2)*Mw2))+s1(2)*(N\(B*U52+...
            (1/h^2)*Mu2))-mc1(2)*W52+Q(2,1)*W_oldL(3,2:nx)';
        
        W61 = W_old1(2:nx)'+dt*((35/384)*Rw11+(500/1113)*Rw31+(125/192)...
            *Rw41-(2187/6784)*Rw51+(11/84)*Rw61);
        W62 = W_old2(2:nx)'+dt*((35/384)*Rw12+(500/1113)*Rw32+(125/192)...
            *Rw42-(2187/6784)*Rw52+(11/84)*Rw62);
        % end............................................................

        ab = isreal(sum(U61)); ac = isreal(sum(U62)); 
        ad = isreal(sum(W61)); ae = isreal(sum(W62)); 
        af = isreal(sff(1)); ag = isreal(sff(2));
        if ab == 1 && ac == 1 && ad == 1 && ae == 1 && af == 1 && ag == 1
            break;
        else
            dt = 0.5*dt;
            Hu1 = Hu1';  Hw1 = Hw1'; Iu1 = Iu1';  Iw1 = Iw1';
            Ju1 = Ju1';  Jw1 = Jw1'; Ku1 = Ku1';  Kw1 = Kw1'; 
            Lu1 = Lu1';  Lw1 = Lw1'; Mu1 = Mu1';  Mw1 = Mw1';
            
            Hu2 = Hu2';  Hw2 = Hw2'; Iu2 = Iu2';  Iw2 = Iw2';
            Ju2 = Ju2';  Jw2 = Jw2'; Ku2 = Ku2';  Kw2 = Kw2';
            Lu2 = Lu2';  Lw2 = Lw2'; Mu2 = Mu2';  Mw2 = Mw2'; 
        end       
    % end.................................................
    end    
    
    % begin.................................................       
    Ua = [K-sff(1),U61',0]; Ub = [K-sff(2),U62',0]; 
    Wa = [-sff(1),W61',0]; Wb = [-sff(2),W62',0];
        
    Uh = [U61(3) U61(6) U61(9) U62(3) U62(6) U62(9)];        
    [UL,WL,YL] = Zh(K,sff,[Ua;Ub],[Wa;Wb],[U_old1;U_old2],...
        [W_old1;W_old2],h,r,sigma);
     
    mt = [sqrt((r(1)-Q(1,1))*K+Q(1,1)*sff(1)-Q(1,2)*UL(2))/...
        sigma(1) sqrt((r(2)-Q(2,2))*K+Q(2,2)*sff(2)-Q(2,1)*...
        UL(3))/sigma(2)];
    
    a4 = [((2*n3*mt(1)*ah^3)/(3*(sigma(1)^4)*sff(1)^2)) ((2*n3*...
        mt(2)*ah^3)/(3*(sigma(2)^4)*sff(2)^2))];
    
    b4 = [((((4*ga(1)*n3*mt(1)*ah^3)/(3*sigma(1)^4))-((2*n2*mt(1)*...
         ah^2)/(3*sigma(1)^2))-(n3*Q(1,1)*sff(1)*ah^3)/(6*(mt(1))...
         *sigma(1)^4)+((n3*Q(1,2)*WL(2)*ah^3)/(6*(mt(1))*...
         sigma(1)^4)))/sff(1)) ((((4*ga(2)*n3*mt(2)*ah^3)/(3*...
         sigma(2)^4))-((2*n2*mt(2)*ah^2)/(3*sigma(2)^2))-(n3*Q(2,2)*...
         sff(2)*ah^3)/(6*(mt(2))*sigma(2)^4)+((n3*Q(2,1)*...
         WL(3)*ah^3)/(6*(mt(2))*sigma(2)^4)))/sff(2))];  
        
    c4 = [(((2*(ga(1)^2)*n3*mt(1)*ah^3)/(3*sigma(1)^4))-(((2*n2*...
         mt(1)*ah^2)/(3*sigma(1)^2))+(n3*Q(1,1)*sff(1)*ah^3)/...
         (6*(mt(1))*sigma(1)^4)-((n3*Q(1,2)*WL(2)*ah^3)/(6*...
         (mt(1))*sigma(1)^4)))*ga(1)-((3*n3*ah^3)/(4*mt(1)))*...
         ((((Q(1,1)^2)*sff(1)^2)/(9*(mt(1)^2)*sigma(1)^4))+...
         (((Q(1,2)*WL(2))^2)/(9*(mt(1)^2)*sigma(1)^4))-((2*...
         Q(1,1)*sff(1)*Q(1,2)*WL(2))/(9*(mt(1)^2)*...
         sigma(1)^4)))+((n2*ah^2)/(3*mt(1)*sigma(1)^2))*(Q(1,1)*...
         sff(1)-Q(1,2)*WL(2))+((n3*mt(1)*(r(1)-Q(1,1))*...
         ah^3)/(2*sigma(1)))+((n3*ah^3)/(4*mt(1)*sigma(1)^2))*(Q(1,1)...
         *sff(1)-Q(1,2)*YL(2))+n1*ah*mt(1)-m1*sqrt(Uh(1)-...
         K+exp(ah)*sff(1))-m2*sqrt(Uh(2)-K+exp(2*ah)*sff(1))-...
         m3*sqrt(Uh(3)-K+exp(3*ah)*sff(1))) (((2*(ga(2)^2)*n3*...
         mt(2)*ah^3)/(3*sigma(2)^4))-(((2*n2*mt(2)*ah^2)/(3*sigma...
         (2)^2))+(n3*Q(2,2)*sff(2)*ah^3)/(6*(mt(2))*sigma(2)^4)-...
         ((n3*Q(2,1)*WL(3)*ah^3)/(6*(mt(2))*sigma(2)^4)))*ga(2)...
         -((3*n3*ah^3)/(4*mt(2)))*((((Q(2,2)^2)*sff(2)^2)/(9*...
         (mt(2)^2)*sigma(2)^4))+(((Q(2,1)*WL(3))^2)/(9*...
         (mt(2)^2)*sigma(2)^4))-((2*Q(2,2)*sff(2)*Q(2,1)*...
         WL(3))/(9*(mt(2)^2)*sigma(2)^4)))+((n2*ah^2)/...
         (3*mt(2)*sigma(2)^2))*(Q(2,2)*sff(2)-Q(2,1)*WL(3))...
         +((n3*mt(2)*(r(2)-Q(2,2))*ah^3)/(2*sigma(2)))+((n3*ah^3)/...
         (4*mt(2)*sigma(2)^2))*(Q(2,2)*sff(2)-Q(2,1)*YL(3))...
         +n1*ah*mt(2)-m1*sqrt(Uh(4)-K+exp(ah)*sff(2))-m2*...
         sqrt(Uh(5)-K+exp(2*ah)*sff(2))-m3*sqrt(Uh(6)-K+exp(3*ah)...
         *sff(2)))];
    
    Ra7 = [((-b4(1)-sqrt(b4(1)^2-4*a4(1)*c4(1)))/(2*a4(1))) ((-b4(2)...
        -sqrt(b4(2)^2-4*a4(2)*c4(2)))/(2*a4(2)))];
     
    sfnew = sff;
    sfne = [(sf_m(1,kk)+dt*((5179/57600)*Ra1(1)+(7571/16695)*Ra3(1)+...
        (393/640)*Ra4(1)-(92097/339200)*Ra5(1)+(187/2100)*Ra6(1)+(1/40)...
        *Ra7(1))) (sf_m(2,kk)+dt*((5179/57600)*Ra1(2)+(7571/16695)*...
        Ra3(2)+(393/640)*Ra4(2)-(92097/339200)*Ra5(2)+(187/2100)*Ra6(2)+...
        (1/40)*Ra7(2)))];

    s1 = [Ra7(1)/sff(1)+r(1)-((sigma(1))^2)/2 Ra7(2)/sff(2)+...
        r(2)-((sigma(2))^2)/2];       
     
    [U_oldL,W_oldL] = NewtHermite(K,sff,[Ua;Ub],[Wa;Wb]...
        ,[U_old1;U_old2],[W_old1;W_old2],nx,h,x_max);


    Nu1(1) = 12*(K-sff(1)); Nu2(1) = 12*(K-sff(2)); 
    Nu1(nx-1) = 0; Nu2(nx-1) = 0;
    Nu1 = Nu1'; Nu2 = Nu2';
        
    Nw1(1) = -12*sff(1);  Nw2(1) = -12*sff(2);
    Nw1(nx-1) = 0; Nw2(nx-1) = 0;
    Nw1 = Nw1'; Nw2 = Nw2';

    Ru71 = (mb1(1))*(N\(B*U61+(1/h^2)*Nu1))+s1(1)*W61-mc1(1)*U61+...
         Q(1,2)*U_oldL(2,2:nx)'; 
    Ru72 = (mb1(2))*(N\(B*U62+(1/h^2)*Nu2))+s1(2)*W62-mc1(2)*U62+...
         Q(2,1)*U_oldL(3,2:nx)';
       
    Um1 = U61;
    Um2 = U62;

    Un1 = U_old1(2:nx)'+dt*((5179/57600)*Ru11+(7571/16695)*Ru31+...
        (393/640)*Ru41-(92097/339200)*Ru51+(187/2100)*Ru61+(1/40)*Ru71);
    Un2 = U_old2(2:nx)'+dt*((5179/57600)*Ru12+(7571/16695)*Ru32+...
        (393/640)*Ru42-(92097/339200)*Ru52+(187/2100)*Ru62+(1/40)*Ru72);
                
    Rw71 = (mb1(1))*(N\(B*W61+(1/h^2)*Nw1))+s1(1)*(N\(B*U61+(1/h^2)*...
        Nu1))-mc1(1)*W61+Q(1,2)*W_oldL(2,2:nx)';
    Rw72 = (mb1(2))*(N\(B*W62+(1/h^2)*Nw2))+s1(2)*(N\(B*U62+(1/h^2)*...
        Nu2))-mc1(2)*W62+Q(2,1)*W_oldL(3,2:nx)';        
  
    Wm1 = W61;
    Wm2 = W62;

    Wn1 = W_old1(2:nx)'+dt*((5179/57600)*Rw11+(7571/16695)*Rw31+...
        (393/640)*Rw41-(92097/339200)*Rw51+(187/2100)*Rw61+(1/40)*Rw71);
    Wn2 = W_old2(2:nx)'+dt*((5179/57600)*Rw12+(7571/16695)*Rw32+...
        (393/640)*Rw42-(92097/339200)*Rw52+(187/2100)*Rw62+(1/40)*Rw72);              
    % end............................................................
    
    Reu(1) = max(abs(Un1-Um1)); Reu(2) = max(abs(Un2-Um2));
    Reu(3) = max(abs(Wn1-Wm1)); Reu(4) = max(abs(Wn2-Wm2));
    Reu(5) = abs(sfnew(1)-sfne(1)); Reu(6) = abs(sfnew(2)-sfne(2));
    aw = abs(max(Reu));
    
   %end: compute the asset option and option Greeks and their error
   
   % begin: transfer values.
   if aw<=Tol
       U_iter1(1) = K-sfnew(1); U_iter1(nx+1) = 0; 
       U_iter2(1) = K-sfnew(2); U_iter2(nx+1) = 0; 
       W_iter1(1) = -sfnew(1); W_iter1(nx+1) = 0;
       W_iter2(1) = -sfnew(2); W_iter2(nx+1) = 0;
       for i = 2:nx
           U_iter1(i) = Um1(i-1); U_iter2(i) = Um2(i-1);
           W_iter1(i) = Wm1(i-1); W_iter2(i) = Wm2(i-1);
       end
       sf_m(:,kk+1) = sfnew; sf=sfnew  % Storing the exercise boundary
       fff(kk) = dt; kk = kk+1;   
       
       for i = 1:nx+1
           U_old1(i) = U_iter1(i); % accepted option value for regime 1 
           W_old1(i) = W_iter1(i); % accepted delta for regime 1
           U_old2(i) = U_iter2(i); % accepted option value for regime 2
           W_old2(i) = W_iter2(i); % accepted delta for regime 2
       end       
        Hu1 = Hu1';  Hw1 = Hw1'; Iu1 = Iu1';  Iw1 = Iw1';
        Ju1 = Ju1';  Jw1 = Jw1'; Ku1 = Ku1';  Kw1 = Kw1';
        Lu1 = Lu1';  Lw1 = Lw1'; Mu1 = Mu1';  Mw1 = Mw1';
        Nu1 = Nu1';  Nw1 = Nw1'; 

        Hu2 = Hu2';  Hw2 = Hw2'; Iu2 = Iu2';  Iw2 = Iw2';
        Ju2 = Ju2';  Jw2 = Jw2'; Ku2 = Ku2';  Kw2 = Kw2';
        Lu2 = Lu2';  Lw2 = Lw2'; Mu2 = Mu2';  Mw2 = Mw2';
        Nu2 = Nu2';  Nw2 = Nw2'; 
        t = t+dt;  
        dt = rho*dt*((Tol/abs(max(Reu)))^(1/4));
        % end: transfer values
    else
        % begin: select the optimal step size
        dt = rho*dt*((Tol/abs(max(Reu)))^(1/5));
        Hu1 = Hu1';  Hw1 = Hw1'; Iu1 = Iu1';  Iw1 = Iw1';
        Ju1 = Ju1';  Jw1 = Jw1'; Ku1 = Ku1';  Kw1 = Kw1';
        Lu1 = Lu1';  Lw1 = Lw1'; Mu1 = Mu1';  Mw1 = Mw1';
        Nu1 = Nu1';  Nw1 = Nw1'; 


        Hu2 = Hu2';  Hw2 = Hw2'; Iu2 = Iu2';  Iw2 = Iw2';
        Ju2 = Ju2';  Jw2 = Jw2'; Ku2 = Ku2';  Kw2 = Kw2';
        Lu2 = Lu2';  Lw2 = Lw2'; Mu2 = Mu2';  Mw2 = Mw2';
        Nu2 = Nu2';  Nw2 = Nw2'; 
        rr = rr+1;
    end    % change the column
end
.............visualization procedure.............................
ay(1) = 0;
for i = 2:length(fff)+1
ay(i) = ay(i-1)+fff(i-1);
end

% begin: convert to original model
for i = 1:nx+1
    S1(i) = exp((i-1)*h)*sfnew(1); % asset price representation for each 
    S2(i) = exp((i-1)*h)*sfnew(2); % regime
end

for i = 1:nx+2
    if i==1
        Smain1(i) = 0; 
        Smain2(i) = 0;   
        Smain3(i) = 0;
        Vmain1(i) = K - Smain1(i); 
        Vmain2(i) = K - Smain2(i);
        Vmain3(i) = K - Smain3(i);
    else
        Smain1(i) = S1(i-1); 
        Smain2(i) = S2(i-1);       % first and second regime asset option
        Smain3(i) = K+(i-2);       % value
        Vmain1(i) = U_iter1(i-1);
        Vmain2(i) = U_iter2(i-1);
        Vmain3(i) = 0;
    end
end

Wmain1(1) = -1;
Wmain2(1) = -1;
for i = 2:nx+2
    Wmain1(i) = W_iter1(i-1)/S1(i-1); % first regime delta 
    Wmain2(i) = W_iter2(i-1)/S2(i-1); % second regime delta      
end 


Table1(1) = interp1(Smain1,Vmain1,3.5); 
Table1(2) = interp1(Smain1,Vmain1,4.0); 
Table1(3) = interp1(Smain1,Vmain1,4.5); 
Table1(4) = interp1(Smain1,Vmain1,6.0);  % interpolating data
Table1(5) = interp1(Smain1,Vmain1,7.5,"spline"); 
Table1(6) = interp1(Smain1,Vmain1,8.5,"spline"); 
Table1(7) = interp1(Smain1,Vmain1,9.0,"spline"); 
Table1(8) = interp1(Smain1,Vmain1,9.5,"spline"); 
Table1(9) = interp1(Smain1,Vmain1,10.5,"spline"); 
Table1(10) = interp1(Smain1,Vmain1,12.0,"spline"); 

Table2(1) = interp1(Smain2,Vmain2,3.5); 
Table2(2) = interp1(Smain2,Vmain2,4.0); 
Table2(3) = interp1(Smain2,Vmain2,4.5); 
Table2(4) = interp1(Smain2,Vmain2,6.0);  % interpolating data
Table2(5) = interp1(Smain2,Vmain2,7.5,"spline"); 
Table2(6) = interp1(Smain2,Vmain2,8.5,"spline"); 
Table2(7) = interp1(Smain2,Vmain2,9.0,"spline"); 
Table2(8) = interp1(Smain2,Vmain2,9.5,"spline"); 
Table2(9) = interp1(Smain2,Vmain2,10.5,"spline"); 
Table2(10) = interp1(Smain2,Vmain2,12.0,"spline"); 

Table3(1) = interp1(Smain1,Wmain1,3.5); 
Table3(2) = interp1(Smain1,Wmain1,4.0); 
Table3(3) = interp1(Smain1,Wmain1,4.5); 
Table3(4) = interp1(Smain1,Wmain1,6.0);  % interpolating data
Table3(5) = interp1(Smain1,Wmain1,7.5,"spline"); 
Table3(6) = interp1(Smain1,Wmain1,8.5,"spline"); 
Table3(7) = interp1(Smain1,Wmain1,9.0,"spline"); 
Table3(8) = interp1(Smain1,Wmain1,9.5,"spline"); 
Table3(9) = interp1(Smain1,Wmain1,10.5,"spline"); 
Table3(10) = interp1(Smain1,Wmain1,12.0,"spline"); 

Table4(1) = interp1(Smain2,Wmain2,3.5); 
Table4(2) = interp1(Smain2,Wmain2,4.0);  
Table4(3) = interp1(Smain2,Wmain2,4.5); % interpolating data
Table4(4) = interp1(Smain2,Wmain2,6.0); 
Table4(5) = interp1(Smain2,Wmain2,7.5,"spline"); 
Table4(6) = interp1(Smain2,Wmain2,8.5,"spline"); 
Table4(7) = interp1(Smain2,Wmain2,9.0,"spline"); 
Table4(8) = interp1(Smain2,Wmain2,9.5,"spline"); 
Table4(9) = interp1(Smain2,Wmain2,10.5,"spline"); 
Table4(10) = interp1(Smain2,Wmain2,12.0,"spline"); 

% start: visualization
subplot(2,2,1)
plot(Smain1,Vmain1,'LineWidth',2)
hold on
plot(Smain2,Vmain2,'--r','LineWidth',2)
hold on
plot(Smain3,Vmain3,'k','LineWidth',2)
axis([0 40 0 9])
set(gca,'FontSize',12)
g=legend('Regime 1','Regime 2','Pay Off');
set(g,'FontSize',12)
o=ylabel('Asset Option','FontSize',14);
get(o)
p=xlabel('Asset Price','FontSize',14);
get(p)
grid on

subplot(2,2,2)
plot(Smain1,Wmain1,'LineWidth',2)
hold on
plot(Smain2,Wmain2,'--r','LineWidth',2)
set(gca,'FontSize',12)
g=legend('Regime 1','Regime 2');
set(g,'FontSize',12)
o=ylabel('Delta Option','FontSize',14);
get(o)
p=xlabel('Asset Price','FontSize',14);
get(p)
grid on
axis([0 40 -1 0])

subplot(2,2,[3,4])
plot(ay,sf_m(1,:),'LineWidth',2)
hold on
plot(ay,sf_m(2,:),'--r','LineWidth',2)
set(gca,'FontSize',12)
g=legend('Regime 1','Regime 2');
set(g,'FontSize',12)
o=ylabel('Optimal Exercise Boundary','FontSize',14);
get(o)
p=xlabel('Time to Maturity','FontSize',14);
get(p)
grid on
axis([0,1,3,9])
% end: visualization
%...................visualization procedure..............................